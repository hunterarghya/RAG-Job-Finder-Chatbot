<!doctype html>
<html>
  <head>
    <title>Dashboard</title>
    <style>
      body {
        font-family: Arial;
        max-width: 900px;
        margin: auto;
        padding: 30px;
        background: #f7f7f7;
      }

      .section {
        background: white;
        padding: 20px;
        margin-bottom: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .status {
        margin-top: 10px;
        font-weight: bold;
      }

      .job-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      }

      .chat-box {
        background: #ffffff;
        padding: 15px;
        border-radius: 8px;
        height: 350px;
        overflow-y: auto;
        margin-bottom: 10px;
        box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
      }

      .msg {
        margin: 10px 0;
        padding: 10px;
        border-radius: 6px;
        max-width: 80%;
      }

      .you {
        background: #d0ebff;
        align-self: flex-end;
      }

      .bot {
        background: #e9ecef;
        align-self: flex-start;
      }

      .chat-input {
        display: flex;
      }

      .chat-input input {
        flex: 1;
        padding: 10px;
      }

      .chat-input button {
        padding: 10px 20px;
      }

      #navbar {
        position: sticky;
        top: 0;
        background: #ffffff;
        padding: 10px 0;
        margin-bottom: 20px;
        z-index: 100;
        border-bottom: 1px solid #ddd;
      }
    </style>
  </head>

  <body>
    <h1>Dashboard</h1>
    <button onclick="logout()">Logout</button>

    <div id="navbar">
      <a href="#profileSection">Profile</a> |
      <a href="#resumeSection">Resume</a> | <a href="#jobsSection">Jobs</a> |
      <a href="#chatSection">Chat</a>
    </div>

    <!-- PROFILE -->
    <div class="section" id="profileSection">
      <h2>Profile</h2>

      <p><b>Name:</b> <span id="profileName">Loading...</span></p>
      <p><b>Email:</b> <span id="profileEmail">Loading...</span></p>

      <p>
        <b>Resume:</b>
        <span id="resumeInfo">Checking...</span>
      </p>
      <div id="resumePreview" style="display: none; margin-top: 10px">
        <iframe
          id="resumeFrame"
          width="100%"
          height="400"
          style="border: 1px solid #ccc"
        ></iframe>
      </div>
    </div>

    <!-- RESUME UPLOAD -->
    <div class="section" id="resumeSection">
      <h2>Upload Resume</h2>

      <input id="resume" type="file" accept="application/pdf" />
      <button id="uploadBtn">Upload</button>

      <p id="resumeStatus" class="status"></p>
    </div>

    <!-- JOB SCRAPER -->
    <div class="section" id="jobsSection">
      <h2>Scrape Jobs</h2>

      <input id="title" placeholder="job title" />
      <input id="loc" placeholder="location" />
      <input id="pages" type="number" min="1" value="1" />

      <button id="scrapeBtn">Scrape</button>

      <p id="scrapeStatus" class="status"></p>

      <h3>Your Saved Jobs</h3>
      <input id="filterCompany" placeholder="Filter by company" />
      <input id="filterTitle" placeholder="Filter by job title" />

      <br /><br />

      <button id="loadJobsBtn">Load Jobs</button>

      <div id="pagination"></div>
      <div id="jobsContainer"></div>
    </div>

    <!-- CHATBOT -->
    <div class="section" id="chatSection">
      <h2>Chat with Bot</h2>

      <div id="chatBox" class="chat-box"></div>

      <div class="chat-input">
        <input id="chatInput" placeholder="Ask something..." />
        <button id="askBtn">Ask</button>
      </div>
    </div>

    <script>
      const token = localStorage.getItem("token");
      let currentPage = 1;
      const LIMIT = 10;

      if (!token) location.href = "/static/login.html";

      // LOGOUT
      function logout() {
        localStorage.removeItem("token");
        location.href = "/static/login.html";
      }

      // Load Profile
      async function loadProfile() {
        const res = await fetch("/api/me", {
          headers: { Authorization: "Bearer " + token },
        });

        if (!res.ok) return;

        const user = await res.json();

        document.getElementById("profileName").innerText = user.name || "N/A";
        document.getElementById("profileEmail").innerText = user.email || "N/A";

        const resumeInfo = document.getElementById("resumeInfo");
        const preview = document.getElementById("resumePreview");
        const frame = document.getElementById("resumeFrame");

        //     if (user.resume_url) {
        //       resumeInfo.innerHTML = `<a href="${user.resume_url}" target="_blank">View Resume</a>`;
        //     } else {
        //       resumeInfo.innerText = "Resume not uploaded yet";
        //     }
        //   }
        if (user.resume_url) {
          resumeInfo.innerHTML = `
    <a href="${user.resume_url}" target="_blank">Open</a> |
    <a href="#" onclick="toggleResume('${user.resume_url}')">Preview</a>
  `;
        } else {
          resumeInfo.innerText = "Resume not uploaded yet";
          preview.style.display = "none";
        }
      }

      loadProfile();

      //  Resume Upload
      //   document.getElementById("uploadBtn").onclick = async () => {
      //     const file = document.getElementById("resume").files[0];
      //     const status = document.getElementById("resumeStatus");

      //     if (!file) {
      //       status.style.color = "red";
      //       status.innerText = "Please select a PDF.";
      //       return;
      //     }

      //     const fd = new FormData();
      //     fd.append("file", file);

      //     const res = await fetch("/api/upload_resume", {
      //       method: "POST",
      //       body: fd,
      //       headers: { Authorization: "Bearer " + token },
      //     });

      //     if (res.ok) {
      //       status.style.color = "green";
      //       status.innerText = "Resume uploaded successfully!";
      //     } else {
      //       status.style.color = "red";
      //       status.innerText = "Upload failed.";
      //     }
      //   };

      document.getElementById("uploadBtn").onclick = async () => {
        const file = document.getElementById("resume").files[0];
        const status = document.getElementById("resumeStatus");

        if (!file) {
          status.style.color = "red";
          status.innerText = "Please select a PDF.";
          return;
        }

        status.style.color = "black";
        status.innerText = "Uploading resume...";

        const fd = new FormData();
        fd.append("file", file);

        try {
          const res = await fetch("/api/upload_resume", {
            method: "POST",
            body: fd,
            headers: { Authorization: "Bearer " + token },
          });

          if (!res.ok) throw new Error();

          status.style.color = "green";
          status.innerText = "Resume uploaded successfully!";
          loadProfile(); // refresh resume link
        } catch {
          status.style.color = "red";
          status.innerText = "Upload failed.";
        }
      };

      //  Scrape Jobs
      //   document.getElementById("scrapeBtn").onclick = async () => {
      //     const title = document.getElementById("title").value;
      //     const loc = document.getElementById("loc").value;
      //     const pages = document.getElementById("pages").value;
      //     const status = document.getElementById("scrapeStatus");

      //     const fd = new FormData();
      //     fd.append("job_title", title);
      //     fd.append("location", loc);
      //     fd.append("pages", pages);

      //     const res = await fetch("/api/scrape", {
      //       method: "POST",
      //       headers: { Authorization: "Bearer " + token },
      //       body: fd,
      //     });

      //     const j = await res.json();

      //     status.style.color = "green";
      //     status.innerText = `${j.count} jobs scraped successfully.`;
      //   };

      document.getElementById("scrapeBtn").onclick = async () => {
        const title = document.getElementById("title").value;
        const loc = document.getElementById("loc").value;
        const pages = document.getElementById("pages").value;
        const status = document.getElementById("scrapeStatus");

        status.style.color = "black";
        status.innerText = "Scraping pages, this may take some time...";

        const fd = new FormData();
        fd.append("job_title", title);
        fd.append("location", loc);
        fd.append("pages", pages);

        try {
          const res = await fetch("/api/scrape", {
            method: "POST",
            headers: { Authorization: "Bearer " + token },
            body: fd,
          });

          if (!res.ok) throw new Error();

          const j = await res.json();
          status.style.color = "green";
          status.innerText = `${j.count} jobs scraped successfully.`;
        } catch {
          status.style.color = "red";
          status.innerText = "Scraping failed.";
        }
      };

      //  Load Jobs
      //   document.getElementById("loadJobsBtn").onclick = async () => {
      //     const container = document.getElementById("jobsContainer");
      //     container.innerHTML = "Loading...";

      //     const res = await fetch("/api/jobs", {
      //       headers: { Authorization: "Bearer " + token },
      //     });

      //     const data = await res.json();
      //     container.innerHTML = ""; // clear

      //     data.jobs.forEach((job) => {
      //       const div = document.createElement("div");
      //       div.className = "job-card";

      //       div.innerHTML = `
      //   <h3>${job.title}</h3>
      //   <p><b>Company:</b> ${job.company}</p>
      //   <p><b>Location:</b> ${job.location}</p>
      //   <p><b>Salary:</b> ${job.salary}</p>
      //   <p><b>Experience:</b> ${job.extra.experience || "N/A"}</p>
      //     <p><b>Tags:</b> ${(job.extra.tags || []).join(", ")}</p>
      //     <p><b>Posted:</b> ${job.extra.post_date || "N/A"}</p>

      //   <p id="desc-${job._id}">
      //     ${job.description.substring(0, 200)}...
      //     </p>

      //     <a href="#" onclick="toggleDescription('${job._id}', \`${job.description.replace(/`/g, "\\`")}\`); return false;" id="readmore-${job._id}">
      //         Read more
      //     </a>
      //     <br><br>

      //   <a href="${job.link}" target="_blank">View Job</a>
      // `;

      //       container.appendChild(div);
      //     });
      //   };
      document.getElementById("loadJobsBtn").onclick = () => loadJobs(1);

      async function loadJobs(page) {
        currentPage = page;

        const company = document.getElementById("filterCompany").value;
        const title = document.getElementById("filterTitle").value;

        const params = new URLSearchParams({
          page,
          limit: LIMIT,
        });

        if (company) params.append("company", company);
        if (title) params.append("title", title);

        const container = document.getElementById("jobsContainer");
        container.innerHTML = "Loading...";

        const res = await fetch("/api/jobs?" + params.toString(), {
          headers: { Authorization: "Bearer " + token },
        });

        const data = await res.json();
        container.innerHTML = "";
        // ---------- EMPTY STATE ----------
        if (!data.jobs || data.jobs.length === 0) {
          container.innerHTML = `
    <p style="color: gray; font-style: italic;">
      No jobs to show yet. Please scrape jobs first.
    </p>
  `;
          document.getElementById("pagination").innerHTML = "";
          return;
        }
        // ---------------------------------

        data.jobs.forEach((job) => {
          const div = document.createElement("div");
          div.className = "job-card";

          div.innerHTML = `
      <h3>${job.title}</h3>
      <p><b>Company:</b> ${job.company}</p>
      <p><b>Location:</b> ${job.location}</p>
      <p><b>Salary:</b> ${job.salary}</p>
      <p><b>Experience:</b> ${job.extra?.experience || "N/A"}</p>
      <p><b>Tags:</b> ${(job.extra?.tags || []).join(", ")}</p>
      <p><b>Posted:</b> ${job.extra?.post_date || "N/A"}</p>

      <p id="desc-${job._id}">
        ${job.description.substring(0, 200)}...
      </p>

      <a href="#" onclick="toggleDescription('${job._id}', \`${job.description.replace(/`/g, "\\`")}\`); return false;">
        Read more
      </a>
      <br><br>

      <a href="${job.link}" target="_blank">View Job</a>
    `;

          container.appendChild(div);
        });

        renderPagination(data.page, data.total_pages);
      }

      // for resume preview
      function toggleResume(url) {
        const preview = document.getElementById("resumePreview");
        const frame = document.getElementById("resumeFrame");

        if (preview.style.display === "none") {
          frame.src = url;
          preview.style.display = "block";
        } else {
          preview.style.display = "none";
          frame.src = "";
        }
      }

      // Pagination rendering
      function renderPagination(page, totalPages) {
        const p = document.getElementById("pagination");
        p.innerHTML = "";

        if (totalPages <= 1) return;

        if (page > 1) {
          p.innerHTML += `<button onclick="loadJobs(${page - 1})">Prev</button>`;
        }

        p.innerHTML += ` Page ${page} of ${totalPages} `;

        if (page < totalPages) {
          p.innerHTML += `<button onclick="loadJobs(${page + 1})">Next</button>`;
        }
      }

      //  Chat System
      const chatBox = document.getElementById("chatBox");
      document.getElementById("askBtn").onclick = sendMessage;

      async function sendMessage() {
        const input = document.getElementById("chatInput");
        const text = input.value.trim();
        if (!text) return;

        appendMessage("you", text);
        input.value = "";

        const res = await fetch("/api/query", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({ query: text }),
        });

        const j = await res.json();
        appendMessage("bot", j.answer || "No response");
      }

      // Append Chat Messages
      function appendMessage(sender, msg) {
        const div = document.createElement("div");
        div.className = `msg ${sender}`;
        div.innerText = msg;

        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function toggleDescription(id, fullText) {
        const p = document.getElementById("desc-" + id);
        const link = document.getElementById("readmore-" + id);

        if (link.innerText === "Read more") {
          p.innerText = fullText; // expand
          link.innerText = "Read less";
        } else {
          p.innerText = fullText.substring(0, 200) + "..."; // collapse
          link.innerText = "Read more";
        }
      }
    </script>
  </body>
</html>
