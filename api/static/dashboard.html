<!doctype html>
<html>
  <head>
    <title>Dashboard</title>
    <style>
      body {
        font-family: Arial;
        max-width: 900px;
        margin: auto;
        padding: 30px;
        background: #dbeafe;
      }

      .section {
        background: white;
        padding: 20px;
        margin-bottom: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .status {
        margin-top: 10px;
        font-weight: bold;
      }

      .job-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      }

      .chat-box {
        background: #ffffff;
        padding: 15px;
        border-radius: 8px;
        height: 350px;
        overflow-y: auto;
        margin-bottom: 10px;
        box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
      }

      .msg {
        margin: 10px 0;
        padding: 10px;
        border-radius: 6px;
        max-width: 80%;
      }

      .you {
        background: #d0ebff;
        align-self: flex-end;
      }

      .bot {
        background: #e9ecef;
        align-self: flex-start;
      }

      .chat-input {
        display: flex;
      }

      .chat-input input {
        flex: 1;
        padding: 10px;
      }

      .chat-input button {
        padding: 10px 20px;
      }

      /* #navbar {
        position: sticky;
        top: 0;
        background: #ffffff;
        padding: 10px 0;
        margin-bottom: 20px;
        z-index: 100;
        border-bottom: 1px solid #ddd;
      } */

      #navbar {
        position: sticky;
        top: 15px; /* Added some breathing room from the top */
        background: rgba(255, 215, 0, 0.2); /* Golden tint with transparency */
        backdrop-filter: blur(10px); /* The "Glass" effect */
        -webkit-backdrop-filter: blur(10px); /* Safari support */
        padding: 10px 20px;
        margin-bottom: 30px;
        z-index: 100;
        border: 1px solid rgba(255, 215, 0, 0.3); /* Soft golden border */
        border-radius: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      /* Styling the links to look like buttons */
      #navbar a {
        text-decoration: none;
        color: #5c4d00; /* Dark gold text */
        background: rgba(255, 255, 255, 0.5);
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 14px;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 215, 0, 0.2);
      }

      #navbar a:hover {
        background: rgba(255, 255, 255, 0.8);
        transform: translateY(-2px);
      }

      /* The Logout Button at the far left */
      #logoutBtn {
        margin-left: auto;
        background: #ff4757;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
      }

      #logoutBtn:hover {
        background: #ff6b81;
      }

      /* Special styling for the AI button */
      #navbar a.ai-button {
        background: linear-gradient(
          135,
          #d4a017 0%,
          #d4a017 100%
        ); /* Soft golden gradient */
        border: 1px solid #ffd700; /* Gold border */
        color: #856404; /* Deep gold text */
        display: flex;
        align-items: center;
        gap: 5px; /* Space between star and text */
        position: relative;
        overflow: hidden;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
      }

      /* Adding a subtle "shimmer" effect to make it look active */
      #navbar a.ai-button::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(45deg);
        transition: all 0.5s;
        pointer-events: none;
      }

      #navbar a.ai-button:hover::after {
        left: 100%;
        top: 100%;
      }

      #navbar a.ai-button:hover {
        background: #fff9db;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        transform: scale(1.05); /* Slight pop out effect */
      }
    </style>
  </head>

  <body>
    <h1>Find your dream job!!!</h1>

    <div id="navbar">
      <a href="#profileSection">Profile</a>
      <a href="#resumeSection">Resume</a> <a href="#jobsSection">Jobs</a>
      <a href="#chatSection" class="ai-button">âœ¨ Ask AI</a>

      <button id="logoutBtn" onclick="logout()">Logout</button>
    </div>

    <!-- PROFILE -->
    <div class="section" id="profileSection">
      <h2>Profile</h2>

      <p><b>Name:</b> <span id="profileName">Loading...</span></p>
      <p><b>Email:</b> <span id="profileEmail">Loading...</span></p>

      <p>
        <b>Resume:</b>
        <span id="resumeInfo">Checking...</span>
      </p>
      <div id="resumePreview" style="display: none; margin-top: 10px">
        <iframe
          id="resumeFrame"
          width="100%"
          height="400"
          style="border: 1px solid #ccc"
        ></iframe>
      </div>
    </div>

    <!-- RESUME UPLOAD -->
    <div class="section" id="resumeSection">
      <h2>Upload Resume</h2>

      <input id="resume" type="file" accept="application/pdf" />
      <button id="uploadBtn">Upload</button>

      <p id="resumeStatus" class="status"></p>
    </div>

    <!-- JOB SCRAPER -->
    <div class="section" id="jobsSection">
      <h2>Scrape Jobs</h2>

      <input id="title" placeholder="job title" />
      <input id="loc" placeholder="location" />
      <input id="pages" type="number" min="1" value="1" />

      <button id="scrapeBtn">Scrape</button>

      <p id="scrapeStatus" class="status"></p>

      <h3>Your Saved Jobs</h3>
      <input id="filterCompany" placeholder="Filter by company" />
      <input id="filterTitle" placeholder="Filter by job title" />

      <br /><br />

      <button id="loadJobsBtn">Load Jobs</button>

      <div id="pagination"></div>
      <div id="jobsContainer"></div>

      <!-- //SCHEDULER------------------------------------------------------ -->
      <div
        class="subsection"
        style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px"
      >
        <h3>Auto-Scraper</h3>
        <input id="autoTitle" placeholder="job title" />
        <input id="autoLoc" placeholder="location" />
        <select id="frequency">
          <option value="off">Off</option>
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
        </select>
        <button id="saveScheduleBtn">Update Schedule</button>
        <p id="scheduleStatus"></p>
      </div>
    </div>

    <!-- CHATBOT -->
    <div class="section" id="chatSection">
      <h2>Chat with Bot</h2>

      <div id="chatBox" class="chat-box"></div>

      <div class="chat-input">
        <input id="chatInput" placeholder="Ask something..." />
        <button id="askBtn">Ask</button>
      </div>
    </div>

    <script>
      const token = localStorage.getItem("token");
      let currentPage = 1;
      const LIMIT = 10;

      if (!token) location.href = "/static/login.html";

      // LOGOUT
      function logout() {
        localStorage.removeItem("token");
        location.href = "/static/login.html";
      }

      // Load Profile
      async function loadProfile() {
        const res = await fetch("/api/me", {
          headers: { Authorization: "Bearer " + token },
        });

        if (!res.ok) return;

        const user = await res.json();

        document.getElementById("profileName").innerText = user.name || "N/A";
        document.getElementById("profileEmail").innerText = user.email || "N/A";

        const resumeInfo = document.getElementById("resumeInfo");
        const preview = document.getElementById("resumePreview");
        const frame = document.getElementById("resumeFrame");

        if (user.resume_url) {
          resumeInfo.innerHTML = `
    <a href="${user.resume_url}" target="_blank">Open</a> |
    <a href="#" onclick="toggleResume('${user.resume_url}')">Preview</a>
  `;
        } else {
          resumeInfo.innerText = "Resume not uploaded yet";
          preview.style.display = "none";
        }
      }

      loadProfile();

      document.getElementById("uploadBtn").onclick = async () => {
        const file = document.getElementById("resume").files[0];
        const status = document.getElementById("resumeStatus");

        if (!file) {
          status.style.color = "red";
          status.innerText = "Please select a PDF.";
          return;
        }

        status.style.color = "black";
        status.innerText = "Uploading resume...";

        const fd = new FormData();
        fd.append("file", file);

        try {
          const res = await fetch("/api/upload_resume", {
            method: "POST",
            body: fd,
            headers: { Authorization: "Bearer " + token },
          });

          if (!res.ok) throw new Error();

          status.style.color = "green";
          status.innerText = "Resume uploaded successfully!";
          loadProfile(); // refresh resume link
        } catch {
          status.style.color = "red";
          status.innerText = "Upload failed.";
        }
      };

      document.getElementById("scrapeBtn").onclick = async () => {
        const title = document.getElementById("title").value;
        const loc = document.getElementById("loc").value;
        const pages = document.getElementById("pages").value;
        const status = document.getElementById("scrapeStatus");

        status.style.color = "black";
        status.innerText = "Scraping pages, this may take some time...";

        const fd = new FormData();
        fd.append("job_title", title);
        fd.append("location", loc);
        fd.append("pages", pages);

        try {
          const res = await fetch("/api/scrape", {
            method: "POST",
            headers: { Authorization: "Bearer " + token },
            body: fd,
          });

          if (!res.ok) throw new Error();

          const j = await res.json();
          status.style.color = "green";
          status.innerText = `${j.count} jobs scraped successfully.`;
        } catch {
          status.style.color = "red";
          status.innerText = "Scraping failed.";
        }
      };

      document.getElementById("loadJobsBtn").onclick = () => loadJobs(1);

      async function loadJobs(page) {
        currentPage = page;

        const company = document.getElementById("filterCompany").value;
        const title = document.getElementById("filterTitle").value;

        const params = new URLSearchParams({
          page,
          limit: LIMIT,
        });

        if (company) params.append("company", company);
        if (title) params.append("title", title);

        const container = document.getElementById("jobsContainer");
        container.innerHTML = "Loading...";

        const res = await fetch("/api/jobs?" + params.toString(), {
          headers: { Authorization: "Bearer " + token },
        });

        const data = await res.json();
        container.innerHTML = "";
        // ---------- EMPTY STATE ----------
        if (!data.jobs || data.jobs.length === 0) {
          container.innerHTML = `
    <p style="color: gray; font-style: italic;">
      No jobs to show yet. Please scrape jobs first.
    </p>
  `;
          document.getElementById("pagination").innerHTML = "";
          return;
        }
        // ---------------------------------

        data.jobs.forEach((job) => {
          const div = document.createElement("div");
          div.className = "job-card";

          div.innerHTML = `
      <h3>${job.title}</h3>
      <p><b>Company:</b> ${job.company}</p>
      <p><b>Location:</b> ${job.location}</p>
      <p><b>Salary:</b> ${job.salary}</p>
      <p><b>Experience:</b> ${job.extra?.experience || "N/A"}</p>
      <p><b>Tags:</b> ${(job.extra?.tags || []).join(", ")}</p>
      <p><b>Posted:</b> ${job.extra?.post_date || "N/A"}</p>

      <p id="desc-${job._id}">
        ${job.description.substring(0, 200)}...
      </p>

      <a href="#" onclick="toggleDescription('${job._id}', \`${job.description.replace(/`/g, "\\`")}\`); return false;">
        Read more
      </a>
      <br><br>

      <a href="${job.link}" target="_blank">View Job</a>
    `;

          container.appendChild(div);
        });

        renderPagination(data.page, data.total_pages);
      }

      // SCHEDULER------------------------------------------------------
      document.getElementById("saveScheduleBtn").onclick = async () => {
        const formData = new FormData();
        formData.append("title", document.getElementById("autoTitle").value);
        formData.append("location", document.getElementById("autoLoc").value);
        formData.append(
          "frequency",
          document.getElementById("frequency").value,
        );

        const res = await fetch("/api/schedule-scraper", {
          method: "POST",
          headers: { Authorization: `Bearer ${token}` },
          body: formData,
        });
        const data = await res.json();
        document.getElementById("scheduleStatus").innerText = data.message;
      };

      // for resume preview
      function toggleResume(url) {
        const preview = document.getElementById("resumePreview");
        const frame = document.getElementById("resumeFrame");

        if (preview.style.display === "none") {
          frame.src = url;
          preview.style.display = "block";
        } else {
          preview.style.display = "none";
          frame.src = "";
        }
      }

      // Pagination rendering
      function renderPagination(page, totalPages) {
        const p = document.getElementById("pagination");
        p.innerHTML = "";

        if (totalPages <= 1) return;

        if (page > 1) {
          p.innerHTML += `<button onclick="loadJobs(${page - 1})">Prev</button>`;
        }

        p.innerHTML += ` Page ${page} of ${totalPages} `;

        if (page < totalPages) {
          p.innerHTML += `<button onclick="loadJobs(${page + 1})">Next</button>`;
        }
      }

      //  Chat System
      const chatBox = document.getElementById("chatBox");
      document.getElementById("askBtn").onclick = sendMessage;

      async function sendMessage() {
        const input = document.getElementById("chatInput");
        const text = input.value.trim();
        if (!text) return;

        appendMessage("you", text);
        input.value = "";

        const res = await fetch("/api/query", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({ query: text }),
        });

        const j = await res.json();
        appendMessage("bot", j.answer || "No response");
      }

      // Append Chat Messages
      function appendMessage(sender, msg) {
        const div = document.createElement("div");
        div.className = `msg ${sender}`;
        div.innerText = msg;

        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function toggleDescription(id, fullText) {
        const p = document.getElementById("desc-" + id);
        const link = document.getElementById("readmore-" + id);

        if (link.innerText === "Read more") {
          p.innerText = fullText; // expand
          link.innerText = "Read less";
        } else {
          p.innerText = fullText.substring(0, 200) + "..."; // collapse
          link.innerText = "Read more";
        }
      }
    </script>
  </body>
</html>
